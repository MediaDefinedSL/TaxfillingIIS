name: Build and Deploy .NET 9 App to IIS

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: windows-latest

    env:
      USERNAME: ${{ secrets.IIS_USER }}
      PASSWORD: ${{ secrets.IIS_PASSWORD }}
      SERVER: ${{ secrets.IIS_SERVER }}

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v3

      - name: âš™ï¸ Setup .NET 9 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: ğŸ“¦ Restore NuGet packages
        run: dotnet restore TaxFiling.sln

      - name: ğŸ› ï¸ Build solution
        run: dotnet build TaxFiling.sln --configuration Release --no-restore

      - name: ğŸ§ª Run tests
        run: dotnet test TaxFiling.sln --no-build --verbosity normal

      - name: ğŸš€ Publish API
        run: dotnet publish ./TaxFiling.API/TaxFiling.API.csproj -c Release -o ./publish/API

      - name: ğŸš€ Publish Web
        run: dotnet publish ./TaxFiling.Web/TaxFiling.Web.csproj -c Release -o ./publish/Web

      - name: ğŸ“¤ Deploy API to IIS
        shell: pwsh
        run: |
          net use \\$env:SERVER\TaxfilingAPI /user:$env:USERNAME $env:PASSWORD
          robocopy ./publish/API \\$env:SERVER\TaxfilingAPI /MIR
          net use \\$env:SERVER\TaxfilingAPI /delete

      - name: ğŸ“¤ Deploy Web to IIS
        shell: pwsh
        run: |
          net use \\$env:SERVER\TaxfilingWeb /user:$env:USERNAME $env:PASSWORD
          robocopy ./publish/Web \\$env:SERVER\TaxfilingWeb /MIR
          net use \\$env:SERVER\TaxfilingWeb /delete
