name: Build and Deploy .NET 9 App to IIS (Web + API)

on:
  push:
    branches:
      - main

jobs:
  build_and_copy:
    runs-on: windows-latest

    env:
      USERNAME: ${{ secrets.IIS_USER }}
      PASSWORD: ${{ secrets.IIS_PASSWORD }}
      SERVER: ${{ secrets.IIS_SERVER }}

    steps:
      - name: üîÑ Checkout code
        uses: actions/checkout@v3

      - name: ‚öôÔ∏è Setup .NET 9 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: üì¶ Restore packages
        run: dotnet restore TaxFiling.sln

      - name: üõ†Ô∏è Build solution
        run: dotnet build TaxFiling.sln --configuration Release --no-restore

      - name: üöÄ Publish API
        run: dotnet publish ./TaxFiling.API/TaxFiling.API.csproj -c Release -o ./publish/API

      - name: üöÄ Publish Web
        run: dotnet publish ./TaxFiling.Web/TaxFiling.Web.csproj -c Release -o ./publish/Web

      - name: üóúÔ∏è Compress Published Folders
        run: |
          Compress-Archive -Path ./publish/API/* -DestinationPath api.zip
          Compress-Archive -Path ./publish/Web/* -DestinationPath web.zip

      - name: üì§ Copy ZIPs and Deploy Script to IIS
        shell: powershell
        run: |
          # Write deploy script locally
          @'
           Import-Module WebAdministration

           Stop-WebAppPool -Name "Taxfilingapi"
           Stop-WebAppPool -Name "taxfilinf.lk"
           Stop-WebAppPool -Name "TexfilingWeb"
           
           

          Expand-Archive -Path "C:\Taxfiling\TaxfilingAPI\api.zip" -DestinationPath "C:\Taxfiling\TaxfilingAPI" -Force
          Expand-Archive -Path "C:\Taxfiling\TaxfilingWeb\web.zip" -DestinationPath "C:\Taxfiling\TaxfilingWeb" -Force

          Start-WebAppPool -Name "Taxfilingapi"
          Start-WebAppPool -Name "taxfilinf.lk"
          Start-WebAppPool -Name "TexfilingWeb"

          "Deploy script executed at $(Get-Date)" | Out-File C:\Taxfiling\deploy-log.txt -Append
          '@ | Out-File -FilePath deploy.ps1 -Encoding utf8

      - name: üì§ Copy ZIPs and Deploy Script to IIS Server
        shell: powershell
        run: |
          net use \\$env:SERVER\TaxfilingAPI /user:$env:USERNAME $env:PASSWORD
          net use \\$env:SERVER\TaxfilingWeb /user:$env:USERNAME $env:PASSWORD

          # Copy files
          Copy-Item api.zip "\\$env:SERVER\TaxfilingAPI\" -Force
          Copy-Item web.zip "\\$env:SERVER\TaxfilingWeb\" -Force
          Copy-Item deploy.ps1 "\\$env:SERVER\TaxfilingWeb\" -Force

          # Disconnect
          net use \\$env:SERVER\TaxfilingAPI /delete
          net use \\$env:SERVER\TaxfilingWeb /delete

      - name: ‚ñ∂Ô∏è Execute deploy script remotely
        shell: pwsh
        run: |
         # Enable unencrypted traffic on the GitHub Actions runner
         Set-Item -Path WSMan:\localhost\Client\AllowUnencrypted -Value $true

         # Add the remote Windows server to TrustedHosts
         Set-Item WSMan:\localhost\Client\TrustedHosts -Value "$env:SERVER" -Force

         # Set credentials
         $secpass = ConvertTo-SecureString "${{ secrets.IIS_PASSWORD }}" -AsPlainText -Force
         $cred = New-Object System.Management.Automation.PSCredential("${{ secrets.IIS_USER }}", $secpass)

         # Run the remote deploy script on your IIS server
         Invoke-Command -ComputerName $env:SERVER `
         -Credential $cred `
         -Authentication Basic `
         -ScriptBlock {
         # your script
         }
